#!/bin/bash

set -euo pipefail

REPO_DIR="${HOME}/.dotfiles"

need() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo >&2 "Missing required command: $1"
    exit 2
  fi
}

need stow

if [ ! -d "${REPO_DIR}" ]; then
  echo >&2 "Dotfiles repo not found at ${REPO_DIR}. Clone it first (e.g., e2 dotfiles-install)."
  exit 1
fi

# Restow core packages into $HOME
echo "Stowing packages from ${REPO_DIR} to ${HOME}..."
pushd "${REPO_DIR}"

stow -v "--dir=${REPO_DIR}" "--target=${HOME}" .

popd

# # Link top-level files not covered by stow packages
# for f in .bashrc .bash_profile .gitconfig; do
#   if [ -e "${REPO_DIR}/${f}" ]; then
#     ln -snf "${REPO_DIR}/${f}" "${HOME}/${f}"
#     echo "Linked ${HOME}/${f} -> ${REPO_DIR}/${f}"
#   fi
# done

echo "Done."
